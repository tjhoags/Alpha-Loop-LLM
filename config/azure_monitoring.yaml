# Azure Monitoring Configuration
# Application Insights and Azure Monitor integration for ALC-Algo

# Application Insights Settings
application_insights:
  enabled: true
  # Connection string from Azure Portal
  # Set APPLICATIONINSIGHTS_CONNECTION_STRING environment variable
  connection_string_env: "APPLICATIONINSIGHTS_CONNECTION_STRING"

  # Sampling configuration (reduce costs by sampling telemetry)
  sampling:
    enabled: true
    sampling_percentage: 100  # 100 = capture all, 50 = capture 50%

  # Auto-collection settings
  auto_collect:
    requests: true  # Track HTTP requests
    dependencies: true  # Track external dependencies (APIs, databases)
    exceptions: true  # Track unhandled exceptions
    performance_counters: true  # Track CPU, memory, etc.

  # Custom event tracking
  custom_events:
    - name: "TradeExecuted"
      properties:
        - symbol
        - side
        - strategy
      measurements:
        - quantity
        - price
        - pnl

    - name: "SignalGenerated"
      properties:
        - symbol
        - signal_type
        - strategy
        - confidence
      measurements:
        - signal_strength

    - name: "PerformanceUpdate"
      properties:
        - strategy
        - timeframe
      measurements:
        - total_return
        - sharpe_ratio
        - max_drawdown
        - win_rate

    - name: "RiskAlert"
      properties:
        - alert_type
        - severity
        - symbol
      measurements:
        - risk_level
        - position_size

    - name: "BacktestCompleted"
      properties:
        - strategy
        - start_date
        - end_date
      measurements:
        - total_trades
        - win_rate
        - profit_factor
        - sharpe_ratio

# Metrics Configuration
metrics:
  # Portfolio metrics
  portfolio:
    - name: "portfolio_value"
      description: "Total portfolio value in USD"
      unit: "USD"
      aggregation: "last"

    - name: "cash_balance"
      description: "Available cash balance"
      unit: "USD"
      aggregation: "last"

    - name: "positions_count"
      description: "Number of open positions"
      unit: "count"
      aggregation: "sum"

    - name: "leverage"
      description: "Portfolio leverage ratio"
      unit: "ratio"
      aggregation: "average"

  # Performance metrics
  performance:
    - name: "daily_return"
      description: "Daily return percentage"
      unit: "percent"
      aggregation: "average"

    - name: "sharpe_ratio"
      description: "Sharpe ratio (rolling 30-day)"
      unit: "ratio"
      aggregation: "average"

    - name: "max_drawdown"
      description: "Maximum drawdown from peak"
      unit: "percent"
      aggregation: "min"

    - name: "volatility"
      description: "Portfolio volatility (30-day)"
      unit: "percent"
      aggregation: "average"

  # Trading metrics
  trading:
    - name: "trades_count"
      description: "Number of trades executed"
      unit: "count"
      aggregation: "sum"

    - name: "trade_latency_ms"
      description: "Trade execution latency"
      unit: "milliseconds"
      aggregation: "average"

    - name: "slippage_bps"
      description: "Execution slippage in basis points"
      unit: "bps"
      aggregation: "average"

    - name: "commission_total"
      description: "Total commission paid"
      unit: "USD"
      aggregation: "sum"

  # System metrics
  system:
    - name: "api_calls_count"
      description: "Number of API calls"
      unit: "count"
      aggregation: "sum"

    - name: "api_latency_ms"
      description: "API call latency"
      unit: "milliseconds"
      aggregation: "average"

    - name: "data_refresh_latency_ms"
      description: "Data refresh latency"
      unit: "milliseconds"
      aggregation: "average"

    - name: "errors_count"
      description: "Number of errors"
      unit: "count"
      aggregation: "sum"

# Alerting Configuration
alerts:
  # Performance alerts
  - name: "large_drawdown"
    metric: "max_drawdown"
    condition: "less_than"
    threshold: -15.0  # Alert if drawdown exceeds -15%
    severity: "warning"
    notification_channels:
      - email
      - slack

  - name: "negative_sharpe"
    metric: "sharpe_ratio"
    condition: "less_than"
    threshold: 0.5
    severity: "warning"

  # Risk alerts
  - name: "high_leverage"
    metric: "leverage"
    condition: "greater_than"
    threshold: 2.0
    severity: "critical"

  - name: "position_concentration"
    metric: "max_position_weight"
    condition: "greater_than"
    threshold: 0.25  # Alert if any position exceeds 25%
    severity: "warning"

  # System alerts
  - name: "high_error_rate"
    metric: "errors_count"
    condition: "greater_than"
    threshold: 10
    time_window_minutes: 5
    severity: "critical"

  - name: "high_api_latency"
    metric: "api_latency_ms"
    condition: "greater_than"
    threshold: 5000  # 5 seconds
    severity: "warning"

  - name: "data_staleness"
    metric: "data_age_minutes"
    condition: "greater_than"
    threshold: 60  # 1 hour
    severity: "warning"

# Logging Configuration
logging:
  # Log levels by component
  levels:
    root: "INFO"
    agents: "INFO"
    strategies: "INFO"
    execution: "DEBUG"  # More verbose for trade execution
    risk: "INFO"
    data: "WARNING"  # Less verbose for data ingestion

  # Azure Log Analytics workspace
  log_analytics:
    enabled: true
    workspace_id_env: "AZURE_LOG_ANALYTICS_WORKSPACE_ID"
    workspace_key_env: "AZURE_LOG_ANALYTICS_WORKSPACE_KEY"

  # Structured logging
  structured:
    enabled: true
    format: "json"
    include_timestamp: true
    include_level: true
    include_logger_name: true
    include_thread_name: false

  # Log retention
  retention:
    application_insights_days: 90
    log_analytics_days: 365

# Dashboard Configuration
dashboards:
  - name: "Trading Overview"
    widgets:
      - type: "metric"
        metric: "portfolio_value"
        visualization: "line_chart"
        time_range: "30d"

      - type: "metric"
        metric: "daily_return"
        visualization: "bar_chart"
        time_range: "30d"

      - type: "metric"
        metrics:
          - "sharpe_ratio"
          - "max_drawdown"
          - "win_rate"
        visualization: "multi_line_chart"
        time_range: "90d"

      - type: "event"
        event: "TradeExecuted"
        group_by: "strategy"
        aggregation: "count"
        time_range: "7d"

  - name: "System Health"
    widgets:
      - type: "metric"
        metric: "api_latency_ms"
        visualization: "line_chart"
        time_range: "24h"

      - type: "metric"
        metric: "errors_count"
        visualization: "bar_chart"
        time_range: "24h"

      - type: "event"
        event: "RiskAlert"
        group_by: "severity"
        time_range: "7d"

# Integration Settings
integrations:
  # Slack notifications
  slack:
    enabled: false
    webhook_url_env: "SLACK_WEBHOOK_URL"
    channels:
      - name: "trading-alerts"
        events:
          - "RiskAlert"
          - "large_drawdown"
      - name: "system-alerts"
        events:
          - "high_error_rate"
          - "high_api_latency"

  # Email notifications
  email:
    enabled: false
    smtp_server: "smtp.gmail.com"
    smtp_port: 587
    from_address_env: "ALERT_EMAIL_FROM"
    to_addresses_env: "ALERT_EMAIL_TO"  # Comma-separated list

# Performance Optimization
optimization:
  # Batching to reduce costs
  batch_telemetry: true
  batch_size: 100
  batch_interval_seconds: 30

  # Filtering to reduce noise
  filter_debug_logs_in_production: true
  filter_successful_health_checks: true

  # Sampling for high-volume events
  high_volume_events:
    - name: "DataPoint"
      sampling_percentage: 10  # Only capture 10%
    - name: "PriceUpdate"
      sampling_percentage: 5
